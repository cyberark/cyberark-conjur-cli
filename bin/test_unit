#!/bin/bash -ex

rm -rf coverage.xml

cleanup() {
  echo "Cleaning up..."
  docker-compose rm --stop --force
}

trap 'echo "ERROR: Test script encountered an error! logs in cleanup.log"; docker-compose logs &> cleanup.log; cleanup' ERR
trap 'cleanup' EXIT
cleanup

echo "Building containers..."
docker-compose build

echo "Starting test env..."
docker-compose up -d --no-deps test

rm -rf $CURRENT_DIR/output/*

docker-compose exec -T \
  --privileged \
  test \
  bash -c ". test/configure_dbus.sh; nose2 -vvv -X --config unit_test.cfg -A '!integration'"
